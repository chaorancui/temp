# 计算性能评估

## TOPS 和 FLOPS 介绍

> 参考链接：
>
> 1. [如何解读算力 TOPS 和 FLOPS 的关系？](https://www.zhihu.com/question/588801710)

算力（Computational Power）通常用两个指标来衡量：**TOPS**（Tera Operations Per Second，万亿次运算每秒）和 **FLOPS**（Floating Point Operations Per Second，每秒浮点运算次数）。

### TOPS（整数运算每秒）

- **TOPS**（Tera Operations Per Second）表示每秒钟执行的总运算次数，其中包括所有类型的运算，包括整数运算、浮点运算、逻辑运算等。但它通常专指 **整数运算**（integer operations），尤其是在与 **AI 推理加速器**（如 **NPU** 或 **TPU**）相关的性能衡量中，强调的是对 **整数运算**（如 INT8、INT16 等）的优化和处理能力。

- **单位**：TOPS 用来描述处理器每秒执行的整数运算次数。根据性能的大小，常见的单位包括：

  - **GTOPS**：每秒十亿次整数运算（$ 10^9 $ TOPS）
  - **TTOPS**：每秒万亿次整数运算（$ 10^{12} $ TOPS）

- **用途**：TOPS 多用于 **AI 推理** 相关的计算，尤其是 **深度学习推理** 中，许多现代硬件（如 GPU、TPU、NPU）都采用整数运算来加速推理过程，而不完全依赖浮点运算，特别是在执行量化模型（例如量化后的神经网络）时。

### FLOPS（浮点运算每秒）

- **FLOPS**（Floating Point Operations Per Second）表示每秒钟能够执行多少次浮点运算。它通常用于衡量处理器（如 CPU 或 GPU）进行数值计算的能力，特别是在科学计算、人工智能训练和图形渲染等任务中，浮点运算是最常见的计算类型。

- **单位**：FLOPS 可以用不同的单位表示。根据性能的大小，常见的单位包括：

  - **GFLOPS**：每秒十亿次浮点运算（$ 10^9 $ FLOPS）
  - **TFLOPS**：每秒万亿次浮点运算（$ 10^{12} $ FLOPS）
  - **PFLOPS**：每秒千万亿次浮点运算（$ 10^{15} $ FLOPS）

- **用途**：FLOPS 用于评估硬件在处理浮点数计算时的性能，尤其是在需要大量浮点运算的应用中（如大规模科学计算、图像处理等）。

### TOPS 和 FLOPS 的关系

1. **浮点运算与整数运算的区别：**

   - **浮点运算**（FLOPS）和 **整数运算**（TOPS）本质上是不同的计算类型。浮点数运算用于精确处理小数和科学计算，而整数运算则用于处理整数值，通常用于更快的推理任务，尤其是在机器学习推理中使用量化模型时。
   - 在 AI 推理中，通常会使用 **量化** 技术将浮点模型转化为低精度的整数模型（例如 INT8、INT16）。通过这种方式，硬件可以在每次计算时执行更多的运算，从而提高推理速度和计算效率。

2. **浮点运算与整数运算的性能差异：**

   - **浮点运算** 通常比 **整数运算** 更为复杂，需要更多的计算资源。尽管现代硬件（如 GPU、TPU）能够高效处理浮点运算，但对于某些特定任务（特别是 AI 推理），**整数运算** 在性能和功耗方面通常具有更大的优势。
   - 例如，现代的 **AI 加速器**（如 NPU）可能会专门优化整数运算，从而在执行推理时显著提高性能，而不需要过多依赖浮点计算。因此，许多加速器和硬件的性能指标可能以 TOPS 为主。

3. **处理能力的平衡：**

   - **FLOPS 和 TOPS** 可以在某些任务中互补，尤其是在进行 **深度学习训练**（通常依赖浮点运算）和 **推理**（通常可以通过量化转换使用整数运算）时。
   - 在推理任务中，许多现代硬件（例如 **NPU** 或 **TPU**）会在计算过程中广泛使用 **整数运算**，而不是完全依赖浮点数，这样可以降低功耗，提高效率。

### 解读 TOPS 和 FLOPS

1. **对于训练任务：**

   - **训练过程** 中，尤其是深度学习的 **反向传播** 和 **梯度计算**，通常依赖于高精度的 **浮点运算**，因此 **FLOPS** 是评估训练任务时更重要的性能指标。
   - 例如，进行 **大规模神经网络训练** 时，FLOPS 是最主要的衡量标准，因为在这种情形下，计算精度和性能要求较高。

2. **对于推理任务：**

   - **推理过程** 通常可以使用 **整数运算**（例如 INT8）来替代浮点运算，尤其是经过量化后的神经网络。通过这种方式，推理性能不再受限于浮点运算的计算精度，而是依赖于硬件如何高效处理低精度整数计算。
   - 在这种情况下，**TOPS** 是更有用的指标，因为它可以反映硬件在处理 **量化神经网络推理** 时的性能，特别是在涉及到 **高效的 AI 推理加速器**（如 NPU）时。

3. **性能转换：**

   - 在硬件设计上，FLOPS 和 TOPS 的计算能力不能直接互换，因为它们涉及到不同的计算类型和架构。
     - **FLOPS** 主要用于反映硬件在执行浮点数计算时的性能，适用于训练等需要高精度计算的任务。
     - **TOPS** 反映硬件在执行整数运算时的性能，适用于推理任务，尤其是量化神经网络的推理。

**总结：**

- **FLOPS** 主要用于衡量浮点计算能力，适用于科学计算、训练等任务。
- **TOPS** 主要用于衡量整数计算能力，特别是针对深度学习推理任务中的量化模型。
- 在 AI 推理中，通过量化模型，可以大幅提升硬件的 **TOPS** 性能，从而提高推理速度和效率，而无需过多依赖高精度的 **FLOPS** 性能。

## Roofline 模型

> 参考链接：
>
> 1. [Roofline Model 与深度学习模型的性能分析](https://zhuanlan.zhihu.com/p/34204282)
> 2. [Roofline 模型（一）：概念、基本公式、图像分析](https://blog.csdn.net/sinat_35360418/article/details/128672715)

Roofline 模型是一种用于分析和评估计算平台性能的可视化工具，它描述了计算机系统（尤其是 CPU 或 GPU）在不同计算强度下的性能上限。该模型帮助我们理解硬件的瓶颈所在，提供了关于计算资源（如计算能力、内存带宽等）限制的直观信息。

### Roofline 模型的基本组成

1. **理论计算上限（Peak Performance）**： 这是系统在理想情况下（如没有内存带宽瓶颈等）能够达到的最高计算性能，通常以浮点运算数（FLOPs）为单位表示。对于 CPU 或 GPU 来说，这个上限通常是它们的浮点运算性能，例如每秒能执行多少亿次浮点运算。
2. **内存带宽限制（Memory Bandwidth Limit）**： 这是系统可以通过内存或缓存传输数据的最大速度。内存带宽的限制会限制数据加载和存储的速度，从而影响整体性能。
3. **计算强度（Operational Intensity, OI）**： 计算强度是指单位数据传输量需要进行的计算量。具体来说，计算强度是每字节数据传输对应的浮点运算次数。计算强度越高，表明每个内存操作处理的计算量越大，系统性能越依赖于计算能力而非内存带宽。

### Roofline 模型的图示

<div style="text-align: center">
<img src="https://picx.zhimg.com/70/v2-8525fb055a972fcdaff0d7fb8fae5712_1440w.avis?source=172ae18b&biz_tag=Post">
</div>

- **横轴：计算强度（OI）**，表示每字节数据传输所对应的浮点运算数。
- **纵轴：性能（通常是 FLOPs）**，表示实际系统的计算性能。

图形上会看到两个主要的“屋顶”线：

1. **内存带宽限制线**：该线的斜率表示内存带宽（FLOPs/字节）。如果程序的计算强度低，计算性能会受到内存带宽的限制，无法突破该带宽限制线。
2. **计算性能上限线**：该线表示系统的理论计算上限，当计算强度非常高时，计算性能主要受到硬件计算能力的限制，系统性能趋近于此上限。

这两条线通常形成一个“屋顶”形状，标志着不同计算强度下系统的性能限制。

### Roofline 模型的应用

- **性能瓶颈分析**：通过查看程序的计算强度，可以判断性能瓶颈是出现在计算资源（如 CPU 或 GPU 的计算能力）上，还是内存带宽上。如果程序的计算强度较低，性能瓶颈通常是内存带宽；如果计算强度较高，瓶颈则可能在计算能力上。
- **性能优化**：根据 Roofline 模型，可以指导开发者如何优化程序，减少内存带宽压力，或者增加计算强度（例如通过算法优化减少内存访问，或者利用并行计算增加计算强度）。

### 总结

Roofline 模型是一种有力的工具，用于理解不同硬件架构（如 CPU、GPU 等）在不同计算负载下的性能表现，帮助开发者发现潜在的性能瓶颈，并指导性能优化。它通过结合内存带宽和计算能力，为评估计算平台的性能提供了直观的图示。

## 卷积的计算强度

### 步骤 1：计算卷积操作的计算强度

我们以一个典型的卷积算子为例，假设它用于处理一个输入特征图和一个卷积核：

- 输入特征图的尺寸：$ W \times H \times C*{in} $，其中 $ W $ 是宽度，$ H $ 是高度，$ C*{in} $ 是输入通道数。
- 卷积核的尺寸：$ K \times K \times C*{in} \times C*{out} $，其中 $ K $ 是卷积核的空间尺寸（假设是 $ K \times K $），$ C\_{out} $ 是输出通道数。

卷积操作需要做的浮点运算量是卷积核与输入特征图的乘法和加法的数量，这个可以表示为：

$$ \text{FLOPs} = 2 \times W \times H \times C*{out} \times K \times K \times C*{in} $$

每次卷积操作涉及的内存传输量是输入特征图的读取和卷积核的读取，以及输出结果的存储。内存传输量大致为：

$$ \text{Memory Accesses} = (W \times H \times C*{in} + K \times K \times C*{in} \times C*{out} + W \times H \times C*{out}) $$

计算强度 $ OI $ 即为每字节数据传输需要多少次浮点运算：

$$ OI = \frac{\text{FLOPs}}{\text{Memory Accesses}} $$

### 步骤 2：计算系统的性能上限

假设我们使用的是某款 GPU，其理论计算性能为 $ P\_{max} $ FLOPs，例如每秒能够进行 1 TFLOP（$ 10^{12} $ FLOPs）操作。GPU 的内存带宽也有限，例如 500 GB/s。我们可以通过 Roofline 模型来绘制系统的性能上限。

1. 计算带宽限制：

   内存带宽的限制会限制我们每秒能够加载和存储多少数据，带宽限制线的斜率可以表示为每个字节数据传输对应的 FLOPs。例如，假设内存带宽为 500 GB/s，且每个字节的数据传输需要 1 次浮点运算（FLOP），则带宽限制线的斜率为：

   $$ \text{Memory Bandwidth Limit} = \frac{\text{Memory Bandwidth}}{\text{Memory Accesses per FLOP}} $$

2. 计算计算性能上限：

   GPU 的理论计算性能上限是 1 TFLOP（$ 10^{12} $ FLOPs），在计算强度非常高时，性能趋近于计算能力的上限。

### 步骤 3：绘制 Roofline 图

1. **横轴（计算强度 OI）**：随着计算强度的增加，系统逐渐不再受限于内存带宽，性能逐渐趋近于 GPU 的计算性能上限。
2. **纵轴（性能）**：表示实际的 FLOPs 性能。

绘制 Roofline 图时，会看到：

- 在低计算强度区域，系统性能受限于内存带宽。
- 在高计算强度区域，性能受限于 GPU 的计算能力上限。

### 步骤 4：评估大模型算子的瓶颈

通过 Roofline 图，我们可以识别出大模型算子在不同计算强度下的性能瓶颈：

- **低计算强度**：如果算子的计算强度较低（例如卷积操作的特征图大小较小，或者没有做优化以提高计算强度），性能将受到内存带宽的限制。此时，可以考虑优化数据访问模式，减少内存带宽压力，或者增加计算强度。
- **高计算强度**：如果算子的计算强度较高（例如，通过大规模并行化来提高计算强度），性能将接近 GPU 的计算能力上限。此时，优化的重点可能会转向计算资源的充分利用，避免浪费计算能力。

### 步骤 5：优化建议

根据 Roofline 模型的分析结果，可能的优化方向包括：

- **优化内存访问模式**：通过减少数据传输或提高数据重用率来降低内存带宽压力，例如通过调整卷积操作的实现方式（例如使用分块、Winograd 算法等技术）。
- **增加计算强度**：通过增加算子的计算复杂度或优化并行性来提高计算强度，避免性能被内存带宽瓶颈限制。
- **硬件适配**：根据模型算子的特点，选择合适的硬件平台进行部署（例如，选择内存带宽更高的硬件或专用的加速器，如 TPU、FPGA 等）。
